generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  STAFF
  ADMIN
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  FAILED
  CANCELLED
}

enum BookingStatus {
  NEW
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum LicenceStatus {
  ACTIVE
  REVOKED
}

enum CounterType {
  INV
  RCP
}

model Tenant {
  id        String        @id @default(uuid()) @db.Uuid
  key       String        @unique
  name      String
  status    String        @default("ACTIVE")
  createdAt DateTime      @default(now())

  domains   TenantDomain[]
  users     User[]
  sessions  Session[]
}

model TenantDomain {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  domain    String   @unique
  isPrimary Boolean  @default(false)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model User {
  id            String    @id @default(uuid()) @db.Uuid
  tenantId      String    @db.Uuid
  email         String
  fullName      String
  passwordHash  String
  role          UserRole  @default(USER)
  verifiedAt    DateTime?
  createdAt     DateTime  @default(now())

  tenant                  Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions                Session[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Session {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId         String  @db.Uuid
  userId           String  @db.Uuid
  sessionTokenHash String  @unique
  expiresAt DateTime
  createdAt        DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
}

model EmailVerificationToken {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  userId    String   @db.Uuid
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  userId    String   @db.Uuid
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
}

model Order {
  id        String      @id @default(uuid()) @db.Uuid
  tenantId  String      @db.Uuid
  ordId     String
  userId    String?     @db.Uuid
  status    OrderStatus @default(PENDING_PAYMENT)
  currency  String      @default("GBP")
  subtotal  Int         @default(0)
  tax       Int         @default(0)
  total     Int         @default(0)
  createdAt DateTime    @default(now())

  items    OrderItem[]
  invoice  Invoice?
  payment  Payment?
  receipt  Receipt?

  @@unique([tenantId, ordId])
  @@index([tenantId])
}

model OrderItem {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  orderId   String   @db.Uuid
  releaseId String   @db.Uuid
  quantity  Int
  unitPrice Int
  currency  String   @default("GBP")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([orderId])
}

model Invoice {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  invNumber   String
  orderId     String   @unique @db.Uuid
  status      String   @default("ISSUED")
  pdfBucket   String?
  pdfObjectKey String?
  createdAt   DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([tenantId, invNumber])
  @@index([tenantId])
}

model Payment {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId           String  @db.Uuid
  orderId            String  @unique @db.Uuid
  provider           String  @default("stripe")
  checkoutSessionId  String  @unique
  paymentIntentId    String?
  status             String  @default("PENDING")
  createdAt          DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Receipt {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid
  rcpNumber    String
  orderId      String   @unique @db.Uuid
  paymentId    String?  @db.Uuid
  pdfBucket    String?
  pdfObjectKey String?
  createdAt    DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([tenantId, rcpNumber])
  @@index([tenantId])
}

model WebhookEvent {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId         String  @db.Uuid
  provider         String  @default("stripe")
  providerEventId  String  @unique
  processedAt      DateTime?
  createdAt        DateTime @default(now())

  @@index([tenantId])
}

model Counter {
  id       String      @id @default(uuid()) @db.Uuid
  tenantId  String     @db.Uuid
  year     Int
  type     CounterType
  value    Int         @default(0)

  @@unique([tenantId, year, type])
  @@index([tenantId])
}

model Release {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId    String  @db.Uuid
  slug       String
  title      String
  version    String
  filename   String
  s3Bucket   String
  s3ObjectKey String
  createdAt  DateTime @default(now())

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model Entitlement {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  userId    String   @db.Uuid
  releaseId String   @db.Uuid
  grantedAt DateTime @default(now())

  @@unique([tenantId, userId, releaseId])
  @@index([tenantId])
  @@index([userId])
}

model Licence {
  id        String       @id @default(uuid()) @db.Uuid
  tenantId  String       @db.Uuid
  userId    String?      @db.Uuid
  licKey    String
  status    LicenceStatus @default(ACTIVE)
  createdAt DateTime     @default(now())

  activation Activation?

  @@unique([tenantId, licKey])
  @@index([tenantId])
}

model Activation {
  id                 String   @id @default(uuid()) @db.Uuid
  tenantId            String  @db.Uuid
  licenceId          String   @unique @db.Uuid
  deviceFingerprintHash String
  activatedAt         DateTime @default(now())

  licence Licence @relation(fields: [licenceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Service {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId     String  @db.Uuid
  slug        String
  name        String
  description String
  price       Int
  currency    String   @default("GBP")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model Booking {
  id                 String        @id @default(uuid()) @db.Uuid
  tenantId            String       @db.Uuid
  bkgRef             String
  status             BookingStatus @default(NEW)
  fullName           String
  email              String
  serviceSlug        String
  serviceNameSnapshot String
  priceSnapshot      Int
  currency           String        @default("GBP")
  preferredAt        DateTime
  notes              String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@unique([tenantId, bkgRef])
  @@index([tenantId])
}

