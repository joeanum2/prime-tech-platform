ARCHITECTURE_LOCK_v1.md

Prime Tech Platform — Architecture Lock
Status: APPROVED
Version: v1
Date: 2026-01-25

This document defines the final, locked architectural decisions for the Prime Tech Platform.
It supersedes any implied or assumed behavior and must be followed exactly during implementation.

1. Tenancy Model (LOCKED)
1.1 Tenancy Resolution

Method: Hostname-based tenant resolution.

Each request resolves tenantId via request host.

Mapping is stored in a TenantDomain table.

All queries must be scoped by tenantId.

1.2 Enforcement

Tenant resolution happens in middleware.

No route may access data without tenant context.

Admin routes are still tenant-bound.

2. Authentication & Roles (LOCKED)
2.1 Authentication

Cookie-based sessions only

HttpOnly cookies

No JWTs in localStorage

Sessions stored in database

2.2 Roles

Defined roles:

USER

STAFF

ADMIN

2.3 Authorisation Rules

Role is stored on User record

Admin routes require ADMIN

Staff routes require STAFF or above

No header-based admin bypass

3. Payments Architecture (LOCKED)
3.1 Stripe Mode

Stripe Checkout Sessions

Checkout initiated via backend

Stripe-hosted checkout UI

Client never handles payment secrets

3.2 Payment Confirmation

Source of truth:
checkout.session.completed webhook

No other Stripe event triggers business logic.

4. Stripe → Internal Mapping (LOCKED)
4.1 Metadata Contract

All Stripe Checkout Sessions MUST include:

metadata:
  ordId
  invNumber
  tenantKey

4.2 Webhook Processing Rules

Webhook signature must be verified

Event ID stored in WebhookEvent

Duplicate events must be ignored

Processing must be idempotent

5. Invoice & Receipt Handling (LOCKED)
5.1 Policy

Invoice created at checkout start (Policy B)

Receipt created only after confirmed payment

PDFs are generated by backend

5.2 Storage

PDFs are uploaded to S3 and referenced by:

Invoice → objectKey

Receipt → objectKey

6. S3 Object Structure (LOCKED)
tenants/{tenantId}/releases/{releaseId}/{filename}
tenants/{tenantId}/invoices/{invNumber}.pdf
tenants/{tenantId}/receipts/{rcpNumber}.pdf

Signed URL Rules

Generated server-side only

TTL: 600 seconds

Never cached or reused

7. Booking System (LOCKED)
7.1 Service Model

Service table exists

Booking stores:

serviceSlug

serviceNameSnapshot

priceSnapshot

7.2 Booking Flow
NEW → CONFIRMED → IN_PROGRESS → COMPLETED


Optional:

CANCELLED (from NEW or CONFIRMED)

7.3 Identifiers

Booking ID format: BKG-XXXXXXXX

8. Licence & Activation (LOCKED)
8.1 Licence Format
LIC-XXXX-XXXX-XXXX

8.2 Activation Rule

MAX = 1 active activation per licence

Enforced at database + service layer

Second activation attempt must return:

error.code = LICENCE_MAX_ACTIVATIONS

9. Sessions (LOCKED)

Stored in database

Linked to User + Tenant

Supports invalidation

Used for:

Auth

Role checks

Admin access

10. Required Environment Variables
Backend
DATABASE_URL
NODE_ENV
PORT
SESSION_SECRET
COOKIE_SECURE
COOKIE_SAMESITE
APP_BASE_URL

Stripe
STRIPE_SECRET_KEY
STRIPE_WEBHOOK_SECRET

AWS
AWS_REGION
AWS_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY
S3_BUCKET_PRIVATE

Frontend
NEXT_PUBLIC_SITE_URL
NEXT_PUBLIC_API_BASE

11. Implementation Rules (MANDATORY)

No feature may be added outside this architecture

No silent assumptions

No inferred behavior

No token-based auth

No public S3 access

No skipping webhook validation

No bypassing tenant scoping

12. Status

✅ Architecture locked
✅ Safe for backend implementation
✅ Codex may proceed to Phase A implementation
